import{e as M,s as d,R as c,j as e,I as T,B as m,l as p,a as F,_ as h,n as k}from"./index-xKrTDA7N.js";import{S as v}from"./Select-DSiwQjuV.js";import{f as N}from"./dateUtils-DFVphTDA.js";import{B as f}from"./Badge-v6lJ1hQp.js";import{S as D}from"./send-BKXNh5eU.js";import{P as I}from"./plus-By_5y3b0.js";const S=M((t,o)=>({tickets:[],loading:!1,error:null,createTicket:async s=>{t({loading:!0});try{const{data:a,error:i}=await d.from("tickets").insert([s]).select().single();if(i)throw i;t(r=>({tickets:[...r.tickets,a],loading:!1}))}catch{t({error:"Failed to create ticket",loading:!1})}},updateTicketStatus:async(s,a)=>{t({loading:!0});try{const{error:i}=await d.from("tickets").update({status:a}).eq("id",s);if(i)throw i;t(r=>({tickets:r.tickets.map(l=>l.id===s?{...l,status:a}:l),loading:!1}))}catch{t({error:"Failed to update ticket status",loading:!1})}},updateTicketPriority:async(s,a)=>{t({loading:!0});try{const{error:i}=await d.from("tickets").update({priority:a}).eq("id",s);if(i)throw i;t(r=>({tickets:r.tickets.map(l=>l.id===s?{...l,priority:a}:l),loading:!1}))}catch{t({error:"Failed to update ticket priority",loading:!1})}},assignTicket:async(s,a)=>{t({loading:!0});try{const{error:i}=await d.from("tickets").update({assigned_to:a}).eq("id",s);if(i)throw i;t(r=>({tickets:r.tickets.map(l=>l.id===s?{...l,assigned_to:a}:l),loading:!1}))}catch{t({error:"Failed to assign ticket",loading:!1})}},addMessage:async(s,a,i=!1)=>{t({loading:!0});try{const{error:r}=await d.from("ticket_messages").insert([{ticket_id:s,message:a,is_internal:i}]);if(r)throw r;t({loading:!1})}catch{t({error:"Failed to add message",loading:!1})}},getMessages:async s=>{try{const{data:a,error:i}=await d.from("ticket_messages").select("*").eq("ticket_id",s).order("created_at",{ascending:!0});if(i)throw i;return a}catch(a){return console.error("Failed to fetch messages:",a),[]}},fetchTickets:async()=>{t({loading:!0});try{const{data:s,error:a}=await d.from("tickets").select("*").order("created_at",{ascending:!1});if(a)throw a;t({tickets:s,loading:!1})}catch{t({error:"Failed to fetch tickets",loading:!1})}}}));function q({onSubmit:t,onCancel:o}){const[s,a]=c.useState({title:"",description:"",priority:"medium"}),i=async r=>{r.preventDefault(),await t(s)};return e.jsxs("form",{onSubmit:i,className:"space-y-6",children:[e.jsx(T,{label:"Titel",value:s.title,onChange:r=>a({...s,title:r.target.value}),required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Beschreibung"}),e.jsx("textarea",{value:s.description,onChange:r=>a({...s,description:r.target.value}),rows:4,className:"w-full rounded-md border-gray-300 shadow-sm focus:border-primary-400 focus:ring-primary-400",required:!0})]}),e.jsxs(v,{label:"Priorität",value:s.priority,onChange:r=>a({...s,priority:r.target.value}),required:!0,children:[e.jsx("option",{value:"low",children:"Niedrig"}),e.jsx("option",{value:"medium",children:"Mittel"}),e.jsx("option",{value:"high",children:"Hoch"}),e.jsx("option",{value:"urgent",children:"Dringend"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(m,{type:"button",variant:"outline",onClick:o,children:"Abbrechen"}),e.jsx(m,{type:"submit",children:"Ticket erstellen"})]})]})}const E={open:"bg-blue-100 text-blue-800",in_progress:"bg-yellow-100 text-yellow-800",waiting_for_response:"bg-purple-100 text-purple-800",resolved:"bg-green-100 text-green-800",closed:"bg-gray-100 text-gray-800"},B={low:"bg-gray-100 text-gray-800",medium:"bg-blue-100 text-blue-800",high:"bg-orange-100 text-orange-800",urgent:"bg-red-100 text-red-800"};function P({tickets:t,onSelect:o}){return t.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(p,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Keine Tickets"}),e.jsx("p",{className:"text-gray-500",children:"Es wurden noch keine Tickets erstellt."})]}):e.jsx("div",{className:"space-y-4",children:t.map(s=>e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-medium",children:s.title}),e.jsx(f,{className:B[s.priority],children:s.priority}),e.jsx(f,{className:E[s.status],children:s.status})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Erstellt am ",N(s.created_at)]})]}),e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>o(s),children:[e.jsx(p,{className:"w-4 h-4 mr-2"}),"Details"]})]})},s.id))})}function A({ticket:t,onClose:o}){const{user:s}=F(),{updateTicketStatus:a,updateTicketPriority:i,addMessage:r,getMessages:l}=S(),[x,g]=c.useState([]),[u,j]=c.useState(""),[w,_]=c.useState(!1),b=(s==null?void 0:s.role)==="admin";c.useEffect(()=>{(async()=>{const y=await l(t.id);g(y)})()},[t.id,l]);const C=async n=>{if(n.preventDefault(),!u.trim())return;await r(t.id,u,w);const y=await l(t.id);g(y),j("")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:t.title}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(f,{children:t.status}),e.jsx(f,{children:t.priority})]})]}),b&&e.jsxs("div",{className:"space-x-2",children:[e.jsxs(v,{value:t.status,onChange:n=>a(t.id,n.target.value),className:"text-sm",children:[e.jsx("option",{value:"open",children:"Offen"}),e.jsx("option",{value:"in_progress",children:"In Bearbeitung"}),e.jsx("option",{value:"waiting_for_response",children:"Warte auf Antwort"}),e.jsx("option",{value:"resolved",children:"Gelöst"}),e.jsx("option",{value:"closed",children:"Geschlossen"})]}),e.jsxs(v,{value:t.priority,onChange:n=>i(t.id,n.target.value),className:"text-sm",children:[e.jsx("option",{value:"low",children:"Niedrig"}),e.jsx("option",{value:"medium",children:"Mittel"}),e.jsx("option",{value:"high",children:"Hoch"}),e.jsx("option",{value:"urgent",children:"Dringend"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("p",{className:"whitespace-pre-wrap",children:t.description}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["Erstellt am ",N(t.created_at)]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-medium flex items-center",children:[e.jsx(p,{className:"w-5 h-5 mr-2"}),"Kommunikationsverlauf"]}),e.jsx("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:x.map(n=>e.jsxs("div",{className:`p-4 rounded-lg ${n.is_internal?"bg-yellow-50 border border-yellow-100":"bg-gray-50"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:n.message}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:[N(n.created_at),n.is_internal&&" (Intern)"]})]},n.id))}),e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsx(T,{value:u,onChange:n=>j(n.target.value),placeholder:"Ihre Nachricht..."}),b&&e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:n=>_(n.target.checked),className:"rounded border-gray-300 text-primary-400 focus:ring-primary-400"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Interne Notiz"})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(m,{type:"button",variant:"outline",onClick:o,children:"Schließen"}),e.jsxs(m,{type:"submit",children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Senden"]})]})]})]})]})}function L(){const{tickets:t,loading:o,createTicket:s,fetchTickets:a}=S(),[i,r]=c.useState(!1),[l,x]=c.useState(null);c.useEffect(()=>{a()},[a]);const g=async u=>{try{await s(u),r(!1),k.success("Ticket erfolgreich erstellt")}catch{k.error("Fehler beim Erstellen des Tickets")}};return e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-primary-400 rounded-xl",children:e.jsx(p,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Support-Tickets"}),e.jsx("p",{className:"text-gray-500",children:"Hier können Sie Ihre Support-Anfragen verwalten"})]})]}),e.jsxs(m,{onClick:()=>r(!0),children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Neues Ticket"]})]}),e.jsx(P,{tickets:t,onSelect:x}),e.jsx(h,{open:i,onClose:()=>r(!1),className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex items-center justify-center min-h-screen p-4",children:[e.jsx(h.Overlay,{className:"fixed inset-0 bg-black/30"}),e.jsxs("div",{className:"relative bg-white rounded-xl max-w-2xl w-full p-6",children:[e.jsx(h.Title,{className:"text-xl font-semibold mb-6",children:"Neues Ticket erstellen"}),e.jsx(q,{onSubmit:g,onCancel:()=>r(!1)})]})]})}),e.jsx(h,{open:!!l,onClose:()=>x(null),className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex items-center justify-center min-h-screen p-4",children:[e.jsx(h.Overlay,{className:"fixed inset-0 bg-black/30"}),e.jsx("div",{className:"relative bg-white rounded-xl max-w-3xl w-full p-6",children:l&&e.jsx(A,{ticket:l,onClose:()=>x(null)})})]})})]})}export{L as default};
